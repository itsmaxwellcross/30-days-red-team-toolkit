"""FTP exploitation"""

import ftplib
from ..config import DEFAULT_TIMEOUT

def exploit_ftp_anonymous(target, port=21):
    """
    Test for anonymous FTP access
    Returns: Result dict or None
    """
    print(f"\n[*] Testing FTP anonymous login on {target}:{port}")
    
    try:
        ftp = ftplib.FTP()
        ftp.connect(target, port, timeout=DEFAULT_TIMEOUT * 2)
        ftp.login()  # Anonymous login
        
        print(f"    [+] Anonymous FTP access granted!")
        
        # List files
        files = []
        ftp.retrlines('LIST', files.append)
        
        print(f"    [+] Directory listing:")
        for f in files[:10]:
            print(f"        {f}")
        
        # Check if writable
        writable = _test_ftp_write(ftp)
        
        result = {
            'service': 'FTP',
            'port': port,
            'username': 'anonymous',
            'password': '',
            'writable': writable,
            'status': 'success'
        }
        
        ftp.quit()
        return result
        
    except Exception as e:
        print(f"    [-] Anonymous access denied")
        return None


def _test_ftp_write(ftp):
    """Test if FTP server allows write access"""
    try:
        test_file = 'test_write.txt'
        ftp.storlines(f'STOR {test_file}', open('/dev/null', 'rb'))
        print(f"    [+] Write access confirmed!")
        
        # Clean up
        try:
            ftp.delete(test_file)
        except:
            pass
        
        return True
    except:
        print(f"    [-] Read-only access")
        return False