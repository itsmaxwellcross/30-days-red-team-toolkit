"""Utilities for finding uploaded files"""

import re
from urllib.parse import urljoin
from ..config import COMMON_UPLOAD_PATHS

class FileFinder:
    """Find uploaded files on the target server"""
    
    def __init__(self, request_handler, target_url):
        self.request_handler = request_handler
        self.target_url = target_url
    
    def find_uploaded_file(self, filename, upload_response):
        """
        Try to locate uploaded file
        Returns: URL of uploaded file or None
        """
        # First, check response for upload path
        if filename in upload_response.text:
            # Try to extract full path from response
            path_match = re.search(rf'(["\'])(.*?{filename})\1', upload_response.text)
            if path_match:
                file_path = path_match.group(2)
                full_url = urljoin(self.target_url, file_path)
                
                # Verify file exists
                if self._verify_file_exists(full_url):
                    return full_url
        
        # Try common paths
        for path in COMMON_UPLOAD_PATHS:
            test_url = urljoin(self.target_url, path + filename)
            if self._verify_file_exists(test_url):
                return test_url
        
        return None
    
    def _verify_file_exists(self, url):
        """Verify file exists at given URL"""
        response = self.request_handler.get(url, timeout=5)
        return response and response.status_code == 200